<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Login & Chat</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }

    #chat {
      display: none;
      margin-top: 20px;
      border: 1px solid black;
    }

    #messages {
      height: 300px;
      border: 1px solid #ccc;
      padding: 10px;
      overflow-y: scroll;
      background: #f9f9f9;
    }

    .message {
      margin-bottom: 10px;
      padding: 5px;
      border-radius: 5px;
    }

    .message.self {
      background: #d4f7dc;
      text-align: right;
    }

    .message.other {
      background: #f7d4d4;
      text-align: left;
    }

    input, button {
      padding: 8px;
      margin-top: 10px;
    }

    #status {
      color: green;
      margin-bottom: 10px;
    }

    #login {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>

  <h2>Login</h2>
  <div id="login">
    <input id="email" type="email" placeholder="Email" required><br>
    <input id="password" type="password" placeholder="Password" required><br>
    <button onclick="login()">Login</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <div id="chat">
    <div id="status">Connecting...</div>
    <div id="messages"></div>
    <input id="textInput" type="text" placeholder="Type a message...">
    <button onclick="sendMessage()">Send</button>
  </div>

  <script>
    let socket;
    let token = '';

    async function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      const res = await fetch('http://localhost:3000/reware/user/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include', // IMPORTANT to allow setting cookie
        body: JSON.stringify({ email, password })
      });

      const data = await res.json();

       if (res.ok ) {
        document.getElementById('login').style.display = 'none';
        document.getElementById('chat').style.display = 'block';
        connectWebSocket(data.user);
      } else {
        document.getElementById('loginError').innerText = data.message || 'Login failed';
      }
    }

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function connectWebSocket(user) {
    
      socket = new WebSocket(`ws://localhost:8080/ws?userId=${user._id}`);

      socket.onopen = () => {
        document.getElementById('status').innerText = 'Connected';
      };

      socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        const messagesDiv = document.getElementById('messages');

        if (data.type === 'MESSAGES_HISTORY') {
          data.payload.messages.forEach(element => {
            const div = document.createElement('div');
          div.className = 'message ' + (element.sender.toString() === user._id.toString() ? 'self' : 'other');
          div.innerText = element.text;
          messagesDiv.appendChild(div);
          });
          
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        } else if (data.type === 'ERROR') {
          alert(data.payload);
        }
      };

      socket.onclose = () => {
        document.getElementById('status').innerText = 'Disconnected';
      };
    }

    function sendMessage() {
      const input = document.getElementById('textInput');
      const text = input.value;
      if (!text.trim()) return;

      // Dummy IDs for testing â€” replace with real ones in your app
      const conversationId = "687c7701bd878a3c163636b1";

      const msg = {
        type: 'GET_MESSAGES',
        payload: {
          conversationId,
          text
        }
      };

      socket.send(JSON.stringify(msg));
      input.value = '';
    }
  </script>
</body>
</html>
